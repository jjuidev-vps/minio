name: s3.jjuidev.com - Host S3 by MinIO deployment to VPS

on:
  push:
    branches:
      - deploy-develop

jobs:
  deploy-develop:
    runs-on: ubuntu-latest
    environment: develop
    steps:
      - name: Checkout repository
        uses: actions/checkout@master
        with:
          fetch-depth: 1

      - name: Install envsubst
        run: |
          sudo apt update
          sudo apt install -y gettext-base

      - name: Prepare docker environment file on runner
        env:
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          PORT: ${{ secrets.PORT }}
          CONSOLE_PORT: ${{ secrets.CONSOLE_PORT }}
        run: |
          # generate docker/.env from template using envsubst
          envsubst < docker/.env.template > docker/.env

      - name: Update repository on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_JJUIDEV_2230_HOST }}
          port: ${{ secrets.VPS_JJUIDEV_2230_PORT }}
          username: ${{ secrets.VPS_JJUIDEV_2230_USERNAME }}
          key: ${{ secrets.VPS_JJUIDEV_2230_SSH_KEY }}
          script: |
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts

            cd /home/jjuidev/jjuidev-vps || exit 1

            if [ -d minio/.git ]; then
              echo "Repository exists → updating code"
              cd minio
              git reset --hard origin/develop && git clean -df
              git branch -D develop-temp || true
              git checkout -b develop-temp
              git branch -D develop || true
              git fetch origin develop
              git checkout develop
            else
              echo "Repository not found → cloning"
              git clone -b develop git@github.com-jjuidev:jjuidev-vps/minio.git || exit 1
              cd minio
              
              git config pull.rebase false
              git config user.name "jjuidev"
              git config user.email "jjuidev@gmail.com"
            fi

      - name: Copy docker environment file to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_JJUIDEV_2230_HOST }}
          port: ${{ secrets.VPS_JJUIDEV_2230_PORT }}
          username: ${{ secrets.VPS_JJUIDEV_2230_USERNAME }}
          key: ${{ secrets.VPS_JJUIDEV_2230_SSH_KEY }}
          source: 'docker/.env'
          target: '/home/jjuidev/jjuidev-vps/minio'

      - name: Start MinIO Docker containers and cleanup environment file
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_JJUIDEV_2230_HOST }}
          port: ${{ secrets.VPS_JJUIDEV_2230_PORT }}
          username: ${{ secrets.VPS_JJUIDEV_2230_USERNAME }}
          key: ${{ secrets.VPS_JJUIDEV_2230_SSH_KEY }}
          script: |
            cd /home/jjuidev/jjuidev-vps/minio || exit 1
            chmod 600 docker/.env

            # Login to Docker Hub if credentials are provided
            if [ -n "${{ secrets.DOCKER_HUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_HUB_TOKEN }}" ]; then
              echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
            fi

            docker compose -f docker/docker-compose.yml -p minio pull
            docker compose -f docker/docker-compose.yml -p minio down
            docker compose -f docker/docker-compose.yml -p minio up -d --remove-orphans

            rm -f docker/.env
